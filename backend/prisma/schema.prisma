generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Company {
  id         Int           @id @default(autoincrement())
  name       String
  slug       String        @unique
  status     CompanyStatus @default(active)
  created_at DateTime      @default(now())
  updated_at DateTime      @updatedAt

  users             User[]
  active_users      User[]         @relation("UserActiveCompany")
  projects          Project[]
  leaves            Leave[]
  notifications     Notification[]
  production_orders ProductionOrder[]
  audit_logs        AuditLog[]

  @@map("companies")
}

enum CompanyStatus {
  active
  inactive
}

// ─── Kullanıcılar ───
model User {
  id            Int       @id @default(autoincrement())
  company_id     Int?
  active_company_id Int?
  email         String    @unique
  password_hash String
  first_name    String
  last_name     String
  role          UserRole  @default(designer)
  country_code  String?
  timezone      String    @default("UTC")
  avatar_url    String?
  is_active     Boolean   @default(true)
  max_capacity  Int       @default(5)
  skills             String?   @db.Text
  failed_login_count      Int       @default(0)
  locked_until            DateTime?
  password_reset_token_hash String? @db.Char(64)
  password_reset_expires  DateTime?
  notification_preferences String?  @db.Text
  created_at              DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  last_login_at      DateTime?

  assigned_projects   Project[]              @relation("AssignedDesigner")
  created_projects    Project[]              @relation("CreatedBy")
  requested_revisions ProjectRevision[]      @relation("RequestedBy")
  status_changes      ProjectStatusHistory[] @relation("ChangedBy")
  daily_logs          DailyLog[]
  leaves              Leave[]                @relation("LeaveUser")
  approved_leaves     Leave[]                @relation("LeaveApprover")
  work_schedule       WorkSchedule?
  notifications       Notification[]
  audit_logs          AuditLog[]
  initiated_orders    ProductionOrder[]      @relation("InitiatedBy")
  approved_orders     ProductionOrder[]      @relation("ApprovedBy")
  permission_sets          PermissionOverride[]      @relation("SetBy")
  notification_rules       NotificationRule[]        @relation("CreatedByRule")
  refresh_tokens           RefreshToken[]
  project_comments         ProjectComment[]          @relation("CommentAuthor")
  uploaded_files           ProjectAttachment[]       @relation("UploadedBy")
  user_permission_overrides UserPermissionOverride[] @relation("UserOverrides")
  set_user_overrides       UserPermissionOverride[]  @relation("UserOverrideSetBy")
  upgrade_requests         RoleUpgradeRequest[]      @relation("UpgradeRequester")
  reviewed_upgrades        RoleUpgradeRequest[]      @relation("UpgradeReviewer")
  push_subscriptions       PushSubscription[]
  subtask_assignments      ProjectSubtask[]          @relation("SubtaskAssignee")
  company                  Company?                   @relation(fields: [company_id], references: [id])
  active_company           Company?                   @relation("UserActiveCompany", fields: [active_company_id], references: [id])

  @@index([company_id])
  @@index([active_company_id])
  @@map("users")
}

enum UserRole {
  super_admin
  admin
  senior_designer
  designer
  production
}

model RefreshToken {
  id          Int      @id @default(autoincrement())
  token_hash  String   @unique @db.Char(64)
  user_id     Int
  expires_at  DateTime
  device_info String?  @db.VarChar(500)
  ip_address  String?  @db.VarChar(45)
  last_used_at DateTime?
  created_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ─── Projeler ───
model Project {
  id                    Int           @id @default(autoincrement())
  company_id            Int?
  nj_number             String
  title                 String
  project_type          ProjectType   @default(single_unit)
  assigned_designer_id  Int?
  priority              Priority      @default(normal)
  status                ProjectStatus @default(new)
  start_date            DateTime?
  deadline              DateTime?
  estimated_finish_date DateTime?
  actual_finish_date    DateTime?
  country_target        CountryTarget @default(china)
  notes                 String?       @db.Text
  admin_notes           String?       @db.Text
  is_hard_deadline      Boolean       @default(false)
  is_archived           Boolean       @default(false)
  monday_item_id        String?
  monday_board_id       String?
  created_by_id         Int?
  created_at            DateTime      @default(now())
  updated_at            DateTime      @updatedAt

  assigned_designer User?                  @relation("AssignedDesigner", fields: [assigned_designer_id], references: [id])
  created_by        User?                  @relation("CreatedBy", fields: [created_by_id], references: [id])
  financials        ProjectFinancial?
  client            ProjectClient?
  revisions         ProjectRevision[]
  status_history    ProjectStatusHistory[]
  daily_logs        DailyLog[]
  notifications     Notification[]
  production_orders ProductionOrder[]
  monday_sync_logs  MondaySyncLog[]
  comments          ProjectComment[]
  attachments       ProjectAttachment[]
  tag_assignments   ProjectTagAssignment[]
  subtasks          ProjectSubtask[]
  company           Company?         @relation(fields: [company_id], references: [id])

  @@unique([company_id, nj_number])
  @@index([company_id])
  @@index([assigned_designer_id])
  @@index([created_by_id])
  @@index([status])
  @@index([created_at])
  @@index([deadline])
  @@map("projects")
}

enum ProjectType {
  single_unit
  multi_unit
  drawing
  revision
}

enum Priority {
  normal
  urgent
  critical
}

enum ProjectStatus {
  new
  designing
  revision
  review
  approved
  in_production
  done
  cancelled
  blocked
}

enum CountryTarget {
  china
  india
  both
}

// ─── Finansal Veriler ───
model ProjectFinancial {
  id              Int           @id @default(autoincrement())
  project_id      Int           @unique
  client_budget   Decimal?      @db.Decimal(12, 2)
  project_price   Decimal?      @db.Decimal(12, 2)
  cost_price      Decimal?      @db.Decimal(12, 2)
  profit_margin   Decimal?      @db.Decimal(5, 2)
  payment_status  PaymentStatus @default(pending)
  invoice_details String?       @db.Text
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("project_financials")
}

enum PaymentStatus {
  pending
  partial
  paid
  overdue
}

// ─── Müşteri Bilgileri ───
model ProjectClient {
  id              Int      @id @default(autoincrement())
  project_id      Int      @unique
  client_name     String?
  contact_info    String?  @db.Text
  company_name    String?
  company_details String?  @db.Text
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("project_clients")
}

// ─── Revizyon Geçmişi ───
model ProjectRevision {
  id              Int          @id @default(autoincrement())
  project_id      Int
  revision_number Int
  requested_by_id Int?
  revision_type   RevisionType @default(client_change)
  description     String?      @db.Text
  notes           String?      @db.Text
  started_at      DateTime?
  completed_at    DateTime?
  created_at      DateTime     @default(now())

  project      Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  requested_by User?   @relation("RequestedBy", fields: [requested_by_id], references: [id])

  @@index([project_id])
  @@index([created_at])
  @@map("project_revisions")
}

enum RevisionType {
  client_change
  internal_fix
  technical_error
}

// ─── Proje Durumu Geçmişi ───
model ProjectStatusHistory {
  id            Int            @id @default(autoincrement())
  project_id    Int
  from_status   ProjectStatus?
  to_status     ProjectStatus
  changed_by_id Int?
  reason        String?
  notes         String?        @db.Text
  changed_at    DateTime       @default(now())

  project    Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  changed_by User?   @relation("ChangedBy", fields: [changed_by_id], references: [id])

  @@index([project_id])
  @@map("project_status_history")
}

// ─── Proje Yorumları ───
model ProjectComment {
  id         Int      @id @default(autoincrement())
  project_id Int
  user_id    Int
  content    String   @db.Text
  is_internal Boolean @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user    User    @relation("CommentAuthor", fields: [user_id], references: [id])

  @@index([project_id])
  @@index([created_at])
  @@map("project_comments")
}

// ─── Proje Ekleri ───
model ProjectAttachment {
  id            Int      @id @default(autoincrement())
  project_id    Int
  uploaded_by_id Int
  file_name     String
  original_name String
  file_path     String
  file_size     Int
  mime_type     String
  created_at    DateTime @default(now())

  project     Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  uploaded_by User    @relation("UploadedBy", fields: [uploaded_by_id], references: [id])

  @@map("project_attachments")
}

// ─── Günlük Log ───
model DailyLog {
  id         Int      @id @default(autoincrement())
  user_id    Int
  project_id Int?
  log_date   DateTime @default(now())
  log_type   LogType  @default(note)
  content    String?  @db.Text
  created_at DateTime @default(now())

  user    User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [project_id], references: [id])

  @@index([user_id, created_at])
  @@index([project_id])
  @@map("daily_logs")
}

enum LogType {
  checkin
  checkout
  note
  update
}

// ─── İzin Kayıtları ───
model Leave {
  id              Int         @id @default(autoincrement())
  company_id       Int?
  user_id         Int
  leave_type      LeaveType   @default(annual)
  start_date      DateTime    @db.Date
  end_date        DateTime    @db.Date
  is_half_day     Boolean     @default(false)
  half_day_period HalfDay?
  status            LeaveStatus @default(pending)
  approved_by_id    Int?
  notes             String?     @db.Text
  rejection_reason  String?     @db.Text
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt

  user        User  @relation("LeaveUser", fields: [user_id], references: [id], onDelete: Cascade)
  approved_by User? @relation("LeaveApprover", fields: [approved_by_id], references: [id])
  company     Company? @relation(fields: [company_id], references: [id])

  @@index([company_id])
  @@index([user_id])
  @@index([start_date, end_date])
  @@map("leaves")
}

enum LeaveType {
  annual
  sick
  excuse
  remote
}

enum HalfDay {
  am
  pm
}

enum LeaveStatus {
  pending
  approved
  rejected
  cancelled
}

// ─── Resmi Tatiller ───
model PublicHoliday {
  id           Int      @id @default(autoincrement())
  country_code String
  holiday_name String
  holiday_date DateTime @db.Date
  is_recurring Boolean  @default(false)
  created_at   DateTime @default(now())

  @@map("public_holidays")
}

// ─── Çalışma Takvimi ───
model WorkSchedule {
  id              Int      @id @default(autoincrement())
  user_id         Int?     @unique
  monday          Boolean  @default(true)
  tuesday         Boolean  @default(true)
  wednesday       Boolean  @default(true)
  thursday        Boolean  @default(true)
  friday          Boolean  @default(true)
  saturday        Boolean  @default(false)
  sunday          Boolean  @default(false)
  work_start_time String   @default("09:00")
  work_end_time   String   @default("18:00")
  created_at      DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("work_schedules")
}

// ─── Bildirim Kuralları ───
model NotificationRule {
  id                Int      @id @default(autoincrement())
  rule_name         String
  rule_type         String
  trigger_condition String
  threshold_value   Int?
  threshold_unit    String?
  target_roles      String?  @db.Text
  channels          String   @default("in_app")
  is_active         Boolean  @default(true)
  created_by_id     Int?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  created_by User? @relation("CreatedByRule", fields: [created_by_id], references: [id])

  @@map("notification_rules")
}

// ─── Bildirimler ───
model Notification {
  id         Int       @id @default(autoincrement())
  company_id Int?
  user_id    Int
  project_id Int?
  type       String
  title      String
  message    String    @db.Text
  is_read    Boolean   @default(false)
  read_at    DateTime?
  action_url String?
  created_at DateTime  @default(now())

  user    User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [project_id], references: [id])
  company Company? @relation(fields: [company_id], references: [id])

  @@index([company_id])
  @@index([user_id, is_read])
  @@index([created_at])
  @@map("notifications")
}

// ─── Place Order ───
model ProductionOrder {
  id                Int         @id @default(autoincrement())
  company_id        Int?
  project_id        Int
  country           CountryTarget
  order_status      OrderStatus @default(pending_approval)
  initiated_by_id   Int?
  approved_by_id    Int?
  order_date        DateTime?
  estimated_arrival DateTime?
  actual_arrival    DateTime?
  tracking_info     String?     @db.Text
  notes             String?     @db.Text
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt

  project      Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  initiated_by User?   @relation("InitiatedBy", fields: [initiated_by_id], references: [id])
  approved_by  User?   @relation("ApprovedBy", fields: [approved_by_id], references: [id])
  company      Company? @relation(fields: [company_id], references: [id])

  @@index([company_id])
  @@index([project_id])
  @@index([order_status])
  @@map("production_orders")
}

enum OrderStatus {
  pending_approval
  approved
  ordered
  shipped
  in_customs
  delivered
  rejected
  rework
}

// ─── Audit Log ───
model AuditLog {
  id            Int      @id @default(autoincrement())
  company_id    Int?
  user_id       Int?
  action        String
  resource_type String
  resource_id   Int?
  old_value     Json?
  new_value     Json?
  ip_address    String?
  user_agent    String?  @db.Text
  created_at    DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id])
  company Company? @relation(fields: [company_id], references: [id])

  @@index([company_id])
  @@index([user_id])
  @@index([resource_type, resource_id])
  @@index([created_at])
  @@map("audit_logs")
}

// ─── Monday Sync Log ───
model MondaySyncLog {
  id             Int           @id @default(autoincrement())
  project_id     Int?
  monday_item_id String?
  sync_direction SyncDirection
  sync_status    SyncStatus
  payload        Json?
  error_message  String?       @db.Text
  created_at     DateTime      @default(now())

  project Project? @relation(fields: [project_id], references: [id])

  @@map("monday_sync_logs")
}

enum SyncDirection {
  push
  pull
}

enum SyncStatus {
  success
  failed
}

// ─── Permission Overrides ───
model PermissionOverride {
  id            Int      @id @default(autoincrement())
  role          UserRole
  field_name    String
  resource_type String
  can_view      Boolean  @default(false)
  can_edit      Boolean  @default(false)
  can_delete    Boolean  @default(false)
  set_by_id     Int?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  set_by User? @relation("SetBy", fields: [set_by_id], references: [id])

  @@unique([role, field_name, resource_type])
  @@map("permission_overrides")
}

// ─── Per-User Permission Override ───
model UserPermissionOverride {
  id            Int       @id @default(autoincrement())
  user_id       Int
  field_name    String
  resource_type String
  can_view      Boolean   @default(false)
  can_edit      Boolean   @default(false)
  expires_at    DateTime?
  reason        String?
  set_by_id     Int
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  user   User @relation("UserOverrides", fields: [user_id], references: [id], onDelete: Cascade)
  set_by User @relation("UserOverrideSetBy", fields: [set_by_id], references: [id])

  @@unique([user_id, field_name, resource_type])
  @@map("user_permission_overrides")
}

// ─── Role Upgrade Request ───
model RoleUpgradeRequest {
  id           Int                  @id @default(autoincrement())
  user_id      Int
  from_role    UserRole
  to_role      UserRole
  reason       String?              @db.Text
  status       RoleUpgradeStatus    @default(pending)
  reviewed_by  Int?
  review_note  String?              @db.Text
  reviewed_at  DateTime?
  created_at   DateTime             @default(now())
  updated_at   DateTime             @updatedAt

  user     User  @relation("UpgradeRequester", fields: [user_id], references: [id], onDelete: Cascade)
  reviewer User? @relation("UpgradeReviewer", fields: [reviewed_by], references: [id])

  @@map("role_upgrade_requests")
}

enum RoleUpgradeStatus {
  pending
  approved
  rejected
}

// ─── Push Subscriptions ───
model PushSubscription {
  id         Int      @id @default(autoincrement())
  user_id    Int
  endpoint   String   @db.Text
  p256dh     String   @db.VarChar(255)
  auth       String   @db.VarChar(255)
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, endpoint(length: 255)])
  @@map("push_subscriptions")
}

// ─── Proje Etiketleri ───
model ProjectTag {
  id         Int      @id @default(autoincrement())
  name       String   @unique @db.VarChar(50)
  color      String   @default("#6366f1") @db.VarChar(10)
  created_at DateTime @default(now())

  projects ProjectTagAssignment[]

  @@map("project_tags")
}

model ProjectTagAssignment {
  id         Int @id @default(autoincrement())
  project_id Int
  tag_id     Int

  project ProjectTag @relation(fields: [tag_id], references: [id], onDelete: Cascade)
  projectRef Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@unique([project_id, tag_id])
  @@index([project_id])
  @@index([tag_id])
  @@map("project_tag_assignments")
}

// ─── Alt Görevler (Subtasks) ───
model ProjectSubtask {
  id             Int      @id @default(autoincrement())
  project_id     Int
  title          String   @db.VarChar(255)
  is_completed   Boolean  @default(false)
  sort_order     Int      @default(0)
  assigned_to_id Int?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  project     Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  assigned_to User?   @relation("SubtaskAssignee", fields: [assigned_to_id], references: [id])

  @@index([project_id])
  @@map("project_subtasks")
}
